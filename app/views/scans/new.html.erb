<!DOCTYPE html>
<html>
  <head>
    <title>Take a Picture</title>
  </head>
  <body>
    <h1>Take a Picture</h1>
    <form id="capture-form" action="/scans" method="post" enctype="multipart/form-data">
      <video id="camera-feed" autoplay></video>
      <input type="file" name="scan[image]" accept="image/*" capture="environment">
      <input type="submit" value="Capture and Upload">
    </form>
    <script>
      <script>
        document.getElementById('capture-form').addEventListener('submit', function (e) {
      e.preventDefault();

      // Access the user's camera
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function (stream) {
          // Display the camera stream in a video element
          var video = document.getElementById('camera-feed');
          video.srcObject = stream;
          document.body.appendChild(video);

          // Capture a frame from the camera and save it as a Blob
          var canvas = document.createElement('canvas');
          var context = canvas.getContext('2d');
          video.onloadedmetadata = function () {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(function (blob) {
              var file = new File([blob], 'captured-image.jpg', { type: 'image/jpeg' });
              var input = document.createElement('input');
              input.type = 'file';
              input.name = 'image';
              // Create a new FileList and add the file to it
              var files = new DataTransfer();
              files.items.add(file);
              input.files = [file]; // Wrap the File object in an array

              // Include the authenticity token in the request headers
              var formData = new FormData();
              formData.append('scan[image]', file);

              formData.append('authenticity_token', document.getElementsByName('csrf-token')[0].content);

              // Create an XMLHttpRequest to send the data
              var xhr = new XMLHttpRequest();
              xhr.open('POST', '/scans', true);
              xhr.setRequestHeader('X-CSRF-Token', document.getElementsByName('csrf-token')[0].content);
              xhr.send(formData);

              document.getElementById('capture-form').appendChild(input);
              video.remove();

              // Submit the form
              document.getElementById('capture-form').submit();
            }, 'image/jpeg');
          };
        })
        .catch(function (error) {
          console.error('Error accessing the camera:', error);
        });
        });
    </script>
  </script>
</body>
</html>
